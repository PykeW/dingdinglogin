<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>登录系统</title>
  <style>
    /* 样式保持不变 */
  </style>
</head>
<body>
  <div class="container">
    <div class="login-box">
      <div class="qr-section">
        <h2 class="section-title">钉钉扫码登录</h2>
        <div class="qr-wrapper">
          <div id="self_defined_element"></div>
        </div>
      </div>
      
      <div class="divider"></div>
      
      <div class="password-section">
        <div class="login-form-wrapper">
          <h2 class="section-title">账号密码登录</h2>
          <form id="loginForm">
            <div class="form-group">
              <input type="email" id="email" placeholder="请输入邮箱" required>
            </div>
            <div class="form-group">
              <input type="password" id="password" placeholder="请输入密码" required>
            </div>
            <button type="submit" class="login-btn">登录</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    // 异步加载钉钉登录脚本
    function loadScript(url, callback) {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src = url;
      script.onload = callback;
      document.head.appendChild(script);
    }

    // 缓存数据示例
    var cache = {};

    function fetchData(url, options = {}) {
      if (cache[url]) {
        return Promise.resolve(cache[url]);
      } else {
        return fetch(url, options)
          .then(response => response.json())
          .then(data => {
            cache[url] = data;
            return data;
          });
      }
    }

    // 初始化钉钉扫码登录
    function initDTFrameLogin() {
      window.DTFrameLogin(
        {
          id: 'self_defined_element',
          width: 280,
          height: 280,
        },
        {	
          redirect_uri: encodeURIComponent('http://10.0.40.25:3666/'),
          client_id: 'ding3tzwvbu0dvxdtunc',
          scope: 'openid',
          response_type: 'code',
          prompt: 'consent',
        },
        async (loginResult) => {
          try {
            const authCode = loginResult.authCode;
            const response = await fetchData(`/auth?authCode=${authCode}`);
            
            const userEmail = response.data.info.email;
            
            // 检查邮箱域名
            if (!userEmail.endsWith('@heils.cn')) {
              alert('只允许 @heils.cn 域名的用户登录！');
              return;
            }
            // 检查用户是否已绑定账号密码
            const bindingStatus = await fetchData('/api/check-binding', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                email: userEmail
              })
            });
            
            if (bindingStatus.isBound) {
              // 已绑定，直接跳转到主页
              window.location.href = '/main';
            } else {
              // 未绑定，跳转到绑定页面
              window.location.href = `/bind?email=${encodeURIComponent(userEmail)}`;
            }
            
          } catch (error) {
            console.error('登录错误:', error);
            alert('登录过程中发生错误，请重试');
          }
        },
        (errorMsg) => {
          console.error('登录错误:', errorMsg);
          alert('登录失败：' + errorMsg);
        }
      );
    }

    // 异步加载钉钉登录脚本并初始化
    loadScript('https://g.alicdn.com/dingding/h5-dingtalk-login/0.21.0/ddlogin.js', initDTFrameLogin);

    // 账号密码登录
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      // 检查邮箱域名
      if (!email.endsWith('@heils.cn')) {
        alert('只允许 @heils.cn 域名的用户登录！');
        return;
      }
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password
          })
        });
        if (!response.ok) {
          throw new Error('登录失败');
        }
        const result = await response.json();
        if (result.success) {
          window.location.href = '/main';
        } else {
          alert(result.message || '账号或密码错误');
        }
      } catch (error) {
        console.error('登录错误:', error);
        alert('登录失败，请重试');
      }
    });
  </script>
</body>
</html>